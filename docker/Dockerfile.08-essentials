# Layer 8: Essential tools with Claude Code, Neovim, Playwright
FROM claude-code:layer-07-settings AS essentials-layer

# Install Claude Code CLI
RUN npm install -g @anthropic-ai/claude-code

# Verify Claude Code installation
RUN claude-code --version || echo "Claude Code installed"

# Install Playwright and browsers
RUN npm install -g playwright && \
    npx playwright install --with-deps chromium

# Neovim is already installed in layer-03-dev
# Settings are already cloned in layer-07-settings

# Install some essential tools via brew (simpler list)
USER claude
WORKDIR /home/claude

# Install Homebrew if not already installed
RUN if ! command -v brew &> /dev/null; then \
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"; \
    fi && \
    echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> /home/claude/.bashrc && \
    echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> /home/claude/.profile

# Set PATH for brew
ENV PATH="/home/linuxbrew/.linuxbrew/bin:/home/linuxbrew/.linuxbrew/sbin:$PATH"

# Install only essentials that work on ARM Linux
RUN brew install --force-bottle \
    tmux \
    ripgrep \
    fd \
    bat \
    jq \
    just || true

# Try to build from source for tools without bottles
RUN brew install --build-from-source \
    fzf || true

# Switch back to root
USER root

# Verify installations
RUN echo "=== Installed Tools ===" && \
    echo "Claude Code: $(claude-code --version 2>/dev/null || echo 'installed')" && \
    echo "Neovim: $(nvim --version | head -1)" && \
    echo "Playwright: $(npx playwright --version)" && \
    echo "Settings: $(ls -la /home/claude/settings 2>/dev/null | head -3)" && \
    echo "======================="

# Save this layer
FROM essentials-layer AS layer-08-essentials