# Layer 3: Development layer for future enhancements
FROM claude-docker:minimal

# This layer is for future development and experimental features
# It builds on top of the stable minimal layer

# Copy container prompt configuration first as root
USER root
SHELL ["/bin/bash", "-c"]
COPY container-prompt.sh /etc/profile.d/container-prompt.sh
RUN chmod +x /etc/profile.d/container-prompt.sh

USER developer
WORKDIR /home/developer

# Use bash for commands (zsh is at different location)
SHELL ["/bin/bash", "-c"]

# Update the repos
# Clone the main repos

RUN ln -s ~/settings ~/gits/settings

RUN cd ~/gits && \
    for repo in */; do \
        if [ -d "$repo/.git" ]; then \
            echo "Updating $repo"; \
            cd "$repo" && git fetch && git rebase && cd ..; \
        fi; \
    done



# Add any development tools or experimental features here
# Examples:
# - Additional language servers for neovim
# - Extra debugging tools
# - Development databases
# - Additional programming language runtimes

# Set up Claude YOLO config for container environment (experimental)
# This allows Claude to run without permission checks in the container
RUN mkdir -p ~/.config/claude && \
    echo '{\
  "permissions": {\
    "yolo": true,\
    "allow": ["*"],\
    "deny": []\
  },\
  "env": {\
    "CLAUDE_MODE": "container",\
    "CLAUDE_CONTAINER": "true"\
  }\
}' > ~/.config/claude/settings.json && \
    echo "Claude configured in YOLO mode for container development"

# Create directories where Claude expects config
RUN mkdir -p ~/.claude ~/.config/claude /tmp/claude-config

# Add claude to PATH properly
ENV PATH="/home/linuxbrew/.linuxbrew/bin:${PATH}"

# Simple approach: just ensure directories exist for mounting
# Auth will be mounted directly from host

# Configure shell to use container prompt
RUN echo '# Docker container prompt setup' >> ~/.zshrc && \
    echo '[ -f /etc/profile.d/container-prompt.sh ] && source /etc/profile.d/container-prompt.sh' >> ~/.zshrc && \
    echo '# Docker container prompt setup' >> ~/.bashrc && \
    echo '[ -f /etc/profile.d/container-prompt.sh ] && source /etc/profile.d/container-prompt.sh' >> ~/.bashrc

RUN brew install yazi tig

# Run lazy sync headless to install all plugins during build
RUN nvim --headless "+Lazy! sync" +qa || true && \
    echo "lazy.nvim plugins installed"

WORKDIR /home/developer/gits
LABEL description="Development layer with Claude YOLO mode, container prompt, and neovim+lazy.nvim"
