FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive
ENV SHELL=/bin/bash

# Create claude user first
RUN useradd -m -s /bin/bash claude && \
    echo "claude ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Install everything in one layer for speed
RUN apt-get update && apt-get install -y \
    # Core tools
    git curl wget sudo build-essential \
    # Required for Claude Code
    nodejs npm python3 python3-pip python3-venv \
    # GitHub and git tools
    gh tig \
    # Essential dev tools
    tmux neovim vim zsh \
    # Network tools
    openssh-client mosh autossh \
    # Search tools
    silversearcher-ag \
    # File tools
    unzip zip \
    # Required for Jekyll blog
    ruby-full ruby-bundler \
    # Image tools
    imagemagick pngquant optipng \
    # Media tools  
    ffmpeg \
    # Data tools
    jq \
    # Build dependencies
    pkg-config libssl-dev \
    && apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Install Jekyll and dependencies
RUN gem install jekyll bundler

# Install Node tools globally
RUN npm install -g \
    typescript \
    @biomejs/biome \
    prettier \
    eslint \
    typescript-language-server \
    vscode-langservers-extracted \
    yaml-language-server \
    vscode-json-languageserver \
    marksman \
    serve \
    fkill-cli

# Install Python tools with pipx
RUN pip3 install --break-system-packages pipx && \
    pipx ensurepath && \
    pipx install uv && \
    pipx install aider-chat && \
    pipx install ruff && \
    pipx install black && \
    pipx install pre-commit && \
    pipx install httpie && \
    pipx install rich-cli && \
    pipx install jupyterlab

# Switch to claude user for Rust installation
USER claude
WORKDIR /home/claude

# Install Rust and essential cargo tools
RUN curl https://sh.rustup.rs -sSf | sh -s -- -y && \
    . $HOME/.cargo/env && \
    cargo install ripgrep fd-find bat eza zoxide starship bottom git-delta

# Create necessary directories
RUN mkdir -p ~/.config ~/.ssh ~/.local/bin ~/scripts ~/.cache

# Pre-configure git aliases and settings
RUN git config --global user.email "idvorkin@gmail.com" && \
    git config --global user.name "Igor Dvorkin" && \
    git config --global push.default simple && \
    git config --global push.autoSetupRemote true && \
    git config --global color.ui true && \
    git config --global alias.co checkout && \
    git config --global alias.com "checkout main" && \
    git config --global alias.fr "pull --rebase" && \
    git config --global alias.br branch && \
    git config --global alias.ci commit && \
    git config --global alias.st status && \
    git config --global alias.logp "log --pretty=format:'%C(yellow)%h%Cred%d %Creset%s %C(yellow)[%cn] %C(green)(%ar)' --decorate" && \
    git config --global core.editor vim

# Add cargo and pipx to PATH in bashrc and zshrc
RUN echo 'export PATH="$HOME/.cargo/bin:$HOME/.local/bin:$PATH"' >> ~/.bashrc && \
    echo 'export PATH="$HOME/.cargo/bin:$HOME/.local/bin:$PATH"' >> ~/.zshrc && \
    echo 'eval "$(zoxide init bash)"' >> ~/.bashrc && \
    echo 'eval "$(starship init bash)"' >> ~/.bashrc

# Copy scripts
COPY --chown=claude:claude scripts/ /home/claude/scripts/
RUN chmod +x /home/claude/scripts/*.sh

# Set working directory
WORKDIR /workspace

# Set entrypoint and default command
ENTRYPOINT ["/home/claude/scripts/entrypoint.sh"]
CMD ["/bin/bash"]